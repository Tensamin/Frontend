pkgname=tensamin-bin
pkgver=0.1.1
pkgrel=1
pkgdesc="Super secure messaging app"
arch=('x86_64' 'aarch64')
url="https://tensamin.methanium.net"
depends=('libsecret')
optdepends=('pam_u2f: OS passkeys' 'pam_fido2: OS passkeys')
source_x86_64=("https://tensamin.methanium.net/release/$pkgver-Tensamin-amd64.tar.xz")
source_aarch64=("https://tensamin.methanium.net/release/$pkgver-Tensamin-arm64.tar.xz")
sha256sums_x86_64=('SKIP')
sha256sums_aarch64=('SKIP')

package() {
  install -d -m 0755 "$pkgdir/opt/$pkgname"

  if [[ -d "$srcdir/$pkgname" ]]; then
    cp -a "$srcdir/$pkgname/." "$pkgdir/opt/$pkgname/"
  elif [[ -f "$srcdir/$pkgname" ]]; then
    cp -a "$srcdir/"* "$pkgdir/opt/$pkgname/"
  else
    for p in "$srcdir"/*; do
      if [[ -f "$p/$pkgname" ]]; then
        cp -a "$p/." "$pkgdir/opt/$pkgname/"
        break
      fi
    done
  fi

  if [[ -f "$pkgdir/opt/$pkgname/$pkgname" ]]; then
    chmod 755 "$pkgdir/opt/$pkgname/$pkgname"
  fi

  if [[ -f "$pkgdir/opt/$pkgname/chrome-sandbox" ]]; then
    chmod 4755 "$pkgdir/opt/$pkgname/chrome-sandbox"
  fi

  install -d "$pkgdir/usr/share/applications"
  cat > "$pkgdir/usr/share/applications/$pkgname.desktop" <<EOF
[Desktop Entry]
Name=Tensamin
Comment=Super secure messaging app
Exec=/usr/bin/$pkgname --ozone-platform=wayland %U
Terminal=false
Type=Application
Categories=Utility;
EOF

  install -d "$pkgdir/usr/bin"
  cat > "$pkgdir/usr/bin/$pkgname" <<'SH'
#!/bin/sh
exec /opt/tensamin-bin/tensamin "$@"
SH
  chmod 755 "$pkgdir/usr/bin/$pkgname"
}